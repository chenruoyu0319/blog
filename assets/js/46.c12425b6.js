(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{234:function(t,e,r){"use strict";r.r(e);var s=r(0),a=Object(s.a)({},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"content"},[t._m(0),t._v(" "),r("blockquote",[r("p",[r("a",{attrs:{href:"https://github.com/GoogleContainerTools/jib",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jib"),r("OutboundLink")],1),t._v(" 是谷歌最新开源的 Java 应用的 Docker 镜像生成工具，可以通过 Gradle 或 Maven 直接生成镜像并上传到仓库而不需要 Dockerfile 文件或者其他插件；Jib 支持将资源文件和类分层打包，可以大幅度提升生成镜像的速度")]),t._v(" "),r("p",[t._v("有一些其他的插件也可以通过 Docker 实现生成镜像，如"),r("a",{attrs:{href:"https://helloworlde.github.io/2018/04/08/Docker-%E6%9E%84%E5%BB%BA-SpringBoot-%E5%BA%94%E7%94%A8/",target:"_blank",rel:"noopener noreferrer"}},[r("code",[t._v("com.palantir.docker")]),r("OutboundLink")],1),t._v("等，但是都需要额外配置 Dockerfile, 如果应用仅需要通过 Dockerfile 构建镜像，建议使用 Jib 来提升构建和上传速度")])]),t._v(" "),t._m(1),t._v(" "),r("h3",{attrs:{id:"添加依赖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#添加依赖","aria-hidden":"true"}},[t._v("#")]),t._v(" "),r("a",{attrs:{href:"https://plugins.gradle.org/plugin/com.google.cloud.tools.jib",target:"_blank",rel:"noopener noreferrer"}},[t._v("添加依赖"),r("OutboundLink")],1)]),t._v(" "),t._m(2),t._v(" "),t._m(3),r("p",[t._v("或")]),t._v(" "),t._m(4),t._m(5),t._v(" "),t._m(6),t._v(" "),r("ul",[r("li",[t._v("直接构建并推送到 "),r("a",{attrs:{href:"https://cloud.google.com/container-registry/",target:"_blank",rel:"noopener noreferrer"}},[t._v("GCR"),r("OutboundLink")],1)])]),t._v(" "),t._m(7),t._v(" "),t._m(8),t._m(9),t._v(" "),r("p",[r("a",{attrs:{href:"https://cloud.google.com/container-registry/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Google Container Center"),r("OutboundLink")],1),t._v(", "),r("a",{attrs:{href:"https://aws.amazon.com/ecr/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Amazon Elastic Container Registry"),r("OutboundLink")],1),t._v(", "),r("a",{attrs:{href:"https://hub.docker.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker Hub Registry"),r("OutboundLink")],1),t._v("之外的 Hub可能会失败，需要先登录到对应的 Docker Hub才可以")]),t._v(" "),t._m(10),t._m(11),t._v(" "),t._m(12),t._m(13),t._v(" "),r("p",[t._v("需要本地 Docker 应用已经启动")]),t._v(" "),t._m(14),r("ul",[r("li",[r("a",{attrs:{href:"https://github.com/GoogleContainerTools/jib/tree/master/jib-gradle-plugin#extended-usage",target:"_blank",rel:"noopener noreferrer"}},[t._v("自定义基础镜像和参数(build.gradle)"),r("OutboundLink")],1)])]),t._v(" "),t._m(15),r("ul",[t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18),t._v(" "),t._m(19),t._v(" "),r("li",[r("a",{attrs:{href:"https://github.com/GoogleContainerTools/jib/tree/master/jib-gradle-plugin#authentication-methods",target:"_blank",rel:"noopener noreferrer"}},[r("code",[t._v("credHelper")]),r("OutboundLink")],1),t._v("：鉴权信息的存放方式，Google 使用 "),r("code",[t._v("gcr")]),t._v(", AWS使用 "),r("code",[t._v("ecr-login")]),t._v(", DockerHub 根据平台使用 "),r("code",[t._v("osxkeychain")]),t._v(", "),r("code",[t._v("wincred")]),t._v(","),r("code",[t._v("secretservice")]),t._v(","),r("code",[t._v("pass")]),t._v("中的一种，可以参考 "),r("a",{attrs:{href:"https://github.com/docker/docker-credential-helpers",target:"_blank",rel:"noopener noreferrer"}},[t._v("docker-credential-helpers"),r("OutboundLink")],1)]),t._v(" "),t._m(20),t._v(" "),t._m(21),t._v(" "),t._m(22),t._v(" "),t._m(23),t._v(" "),t._m(24)]),t._v(" "),r("p",[t._v("推荐"),r("code",[t._v("from")]),t._v(" 改为 "),r("code",[t._v("registry.hub.docker.com/openjdk:8-jdk-alpine")]),t._v(", "),r("code",[t._v("to")]),t._v("改为 "),r("code",[t._v("registry.cn-qingdao.aliyuncs.com")]),t._v(" 等国内的仓库，同时将  Docker 的镜像源改为"),r("a",{attrs:{href:"https://registry.docker-cn.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://registry.docker-cn.com"),r("OutboundLink")],1),t._v(" 或 "),r("a",{attrs:{href:"https://docker.mirrors.ustc.edu.cn",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docker.mirrors.ustc.edu.cn"),r("OutboundLink")],1),t._v("以减少构建时间")]),t._v(" "),r("hr"),t._v(" "),t._m(25),t._v(" "),t._m(26),t._v(" "),t._m(27),t._v(" "),t._m(28),t._m(29),t._v(" "),r("p",[t._v("这个问题很容易出现，主要是因为在国内无法访问"),r("a",{attrs:{href:"https://gcr.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("gcr.io"),r("OutboundLink")],1),t._v("导致的，推荐使用 SS 的全局模式或者 "),r("a",{attrs:{href:"https://www.getoutline.org/en/home",target:"_blank",rel:"noopener noreferrer"}},[t._v("Outline"),r("OutboundLink")],1),t._v(" 或其他可以访问到 "),r("a",{attrs:{href:"https://gcr.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("gcr.io"),r("OutboundLink")],1),t._v(" 的工具；一定要确保 Terminal 或者服务器可以访问到  "),r("a",{attrs:{href:"https://gcr.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("gcr.io"),r("OutboundLink")],1),t._v(" 才能在不指定仓库时构建成功；或者指定国内的仓库，不需要访问谷歌的仓库")])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"使用-jib-生成-java-docker-镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-jib-生成-java-docker-镜像","aria-hidden":"true"}},[this._v("#")]),this._v(" 使用 Jib 生成  Java Docker 镜像")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用","aria-hidden":"true"}},[this._v("#")]),this._v(" 使用")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("Gradle")])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-groovy extra-class"},[r("pre",{pre:!0,attrs:{class:"language-groovy"}},[r("code",[t._v("\nbuildscript "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    repositories "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        maven "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" url "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://plugins.gradle.org/m2/'")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    dependencies "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        classpath "),r("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"gradle.plugin.com.google.cloud.tools:jib-gradle-plugin:0.9.6"')]),t._v("\n    "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\napply plugin"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"com.google.cloud.tools.jib"')]),t._v("\n\n")])])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-groovy extra-class"},[r("pre",{pre:!0,attrs:{class:"language-groovy"}},[r("code",[t._v("plugins "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  id "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'com.google.cloud.tools.jib'")]),t._v(" version "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'0.9.6'")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"构建镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#构建镜像","aria-hidden":"true"}},[this._v("#")]),this._v(" 构建镜像")])},function(){var t=this.$createElement,e=this._self._c||t;return e("blockquote",[e("p",[this._v("以下方式都需要终端能够访问 "),e("code",[this._v("gcr.io")]),this._v("或 "),e("code",[this._v("hub.docker.com")]),this._v("等 Docker Hub 才能成功")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("通过这种方式构建的镜像会以"),e("code",[this._v("gcr.io/distroless/java")]),this._v("为底层镜像，编译之后生成镜像，并推送到 Google 容器镜像仓库中：")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("gradle jib\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("指定推送的容器镜像仓库")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("gradle jib --image registry.hub.docker.com/helloworld/java:jib\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("或者在"),e("code",[this._v("build.gradle")]),this._v("中以下添加之后执行 "),e("code",[this._v("gradle jib")])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-groovy extra-class"},[r("pre",{pre:!0,attrs:{class:"language-groovy"}},[r("code",[t._v("jib"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("to"),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("image "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'registry.hub.docker.com/helloworld/java:jib'")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("保存在本地")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("gradle jibDockerBuild\n")])])])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-groovy extra-class"},[r("pre",{pre:!0,attrs:{class:"language-groovy"}},[r("code",[t._v("jib "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    from "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        image "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'registry.hub.docker.com/openjdk:8-jdk-alpine'")]),t._v("\n        auth "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            username "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'username'")]),t._v("\n            password "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'password'")]),t._v("\n        "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    to "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        image "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'registry.hub.docker.com/helloword/java:jib'")]),t._v("\n        auth "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            username "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'username'")]),t._v("\n            password "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'password'")]),t._v("\n        "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        credHelper "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'osxkeychain'")]),t._v("\n    "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    container "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        jvmFlags "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'-Djava.security.egd=file:/dev/./urandom'")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'-Duser.timezone=GMT+08'")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        mainClass "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'example.jib.MainClass'")]),t._v("\n        args "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("'test"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        ports "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8080'")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("from")]),this._v("：拉取的镜像的配置，默认为"),e("code",[this._v("gcr.io/distroless/java")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("to")]),this._v(":要生成的镜像的配置")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("image")]),this._v("：拉取或生成的镜像名称")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("auth")]),this._v(": 认证信息，分别为用户名和密码")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("container")]),this._v(": 容器的属性")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("jvmFlgs")]),this._v(": JVM 容器的参数，和 Dockerfile 的 "),e("code",[this._v("ENTRYPOINT")]),this._v("作用相同")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("mainClass")]),this._v(": 启动类限定名")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("args")]),this._v(": "),e("code",[this._v("main")]),this._v(" 方法的传入参数")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[e("code",[this._v("ports")]),this._v(": 容器暴露的端口，和 Dockerfile 的"),e("code",[this._v("EXPOSE")]),this._v("作用相同")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题","aria-hidden":"true"}},[this._v("#")]),this._v(" 问题")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("登录失败，未授权(401 Unauthorized)")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("出现这种问题一般是因为没有登录对应的Docker Registry 导致的，需要配置用户登录到相应的容器服务，或者在"),e("code",[this._v("from")]),this._v("和"),e("code",[this._v("to")]),this._v(" 节点手动添加账户配置：")])},function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"language-groovy extra-class"},[r("pre",{pre:!0,attrs:{class:"language-groovy"}},[r("code",[t._v("        auth "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            username "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'username'")]),t._v("\n            password "),r("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v("'password'")]),t._v("\n        "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("连接超时( Connect to gcr.io/108.177.125.82:443 timed out)")])])}],!1,null,null,null);a.options.__file="使用-Jib-生成-Java-Docker-镜像.md";e.default=a.exports}}]);